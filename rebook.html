<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReBook - Used Book Exchange</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav>
        <a href="#" onclick="showSection('customer')">Customer View</a>
        <a href="#" onclick="showSection('seller')">Seller View</a>
    </nav>
    <div class="container">
        <div id="customer" class="section active">
            <h1>Customer View</h1>
            <h2>Available Books</h2>
            <div id="book-list"></div>
            <h2>Request a Book</h2>
            <form id="request-form">
                <label>
                    Name:
                    <input type="text" name="name" required>
                </label>
                <label>
                    Contact (Email/Phone):
                    <input type="text" name="contact" required>
                </label>
                <label>
                    Location:
                    <select name="location" required>
                        <option value="Amman">عمان - Amman</option>
                        <option value="Irbid">إربد - Irbid</option>
                        <option value="Zarqa">الزرقاء - Zarqa</option>
                        <option value="Balqa">البلقاء - Balqa</option>
                        <option value="Karak">الكرك - Karak</option>
                        <option value="Ma'an">معان - Ma'an</option>
                        <option value="Mafraq">المفرق - Mafraq</option>
                        <option value="Tafila">الطفيلة - Tafila</option>
                        <option value="Aqaba">العقبة - Aqaba</option>
                        <option value="Jerash">جرش - Jerash</option>
                        <option value="Ajloun">عجلون - Ajloun</option>
                        <option value="Madaba">مأدبا - Madaba</option>
                    </select>
                </label>
                <label>
                    Book ID:
                    <input type="number" name="bookId" required>
                </label>
                <button type="submit">Submit Request</button>
            </form>
        </div>
        <div id="seller" class="section">
            <h1>Seller View</h1>
            <h2>Add New Book</h2>
            <form id="add-book-form">
                <label>
                    Title:
                    <input type="text" name="title" required>
                </label>
                <label>
                    Description:
                    <textarea name="description" required></textarea>
                </label>
                <label>
                    Price (JOD):
                    <input type="number" name="price" step="0.01" min="0" required>
                </label>
                <label>
                    Image URL (Optional):
                    <input type="text" name="image" placeholder="e.g., images/book.jpg">
                </label>
                <p class="note">Note: New books are saved in browser storage and visible until cleared.</p>
                <button type="submit">Add Book</button>
            </form>
            <h2>Incoming Requests</h2>
            <div id="location-filter">
                <label>
                    Filter by City:
                    <select id="city-filter" onchange="loadRequests()">
                        <option value="">All Cities</option>
                        <option value="Amman">عمان - Amman</option>
                        <option value="Irbid">إربد - Irbid</option>
                        <option value="Zarqa">الزرقاء - Zarqa</option>
                        <option value="Balqa">البلقاء - Balqa</option>
                        <option value="Karak">الكرك - Karak</option>
                        <option value="Ma'an">معان - Ma'an</option>
                        <option value="Mafraq">المفرق - Mafraq</option>
                        <option value="Tafila">الطفيلة - Tafila</option>
                        <option value="Aqaba">العقبة - Aqaba</option>
                        <option value="Jerash">جرش - Jerash</option>
                        <option value="Ajloun">عجلون - Ajloun</option>
                        <option value="Madaba">مأدبا - Madaba</option>
                    </select>
                </label>
            </div>
            <div id="request-list">
                <table class="request-table">
                    <thead>
                        <tr>
                            <th>Book ID</th>
                            <th>Customer Name</th>
                            <th>Contact</th>
                            <th>Location</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="request-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        // Show/hide sections
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            if (sectionId === 'seller') {
                loadRequests();
            }
        }

        // Load books from books.json
        async function loadBooks() {
            try {
                const response = await fetch('books.json');
                const books = await response.json();
                // Merge with localStorage books, ensuring unique IDs
                let localBooks = JSON.parse(localStorage.getItem('books') || '[]');
                const maxJsonId = Math.max(...books.map(book => book.id), 0);
                localBooks = localBooks.map((book, index) => ({
                    ...book,
                    id: maxJsonId + index + 1
                }));
                const allBooks = [...books, ...localBooks];
                displayBooks(allBooks);
            } catch (error) {
                console.error('Error loading books:', error);
                const fallbackBooks = [
                    {
                        id: 1,
                        title: "كليلة ودمنة",
                        description: "نسخة ورقية مستعملة، بعض الصفحات مطوية، حالة جيدة.",
                        price: 3.50,
                        image: "images/book1.jpg"
                    }
                ];
                // Merge with localStorage books, ensuring unique IDs
                let localBooks = JSON.parse(localStorage.getItem('books') || '[]');
                const maxJsonId = Math.max(...fallbackBooks.map(book => book.id), 0);
                localBooks = localBooks.map((book, index) => ({
                    ...book,
                    id: maxJsonId + index + 1
                }));
                const allBooks = [...fallbackBooks, ...localBooks];
                displayBooks(allBooks);
            }
        }

        // Display books in Customer View
        function displayBooks(books) {
            const bookList = document.getElementById('book-list');
            bookList.innerHTML = '';
            books.forEach(book => {
                const bookCard = document.createElement('div');
                bookCard.className = 'book-card';
                bookCard.innerHTML = `
                    <img src="${book.image || 'https://via.placeholder.com/150'}" alt="${book.title}">
                    <h3>${book.title}</h3>
                    <p>${book.description}</p>
                    <p class="price">${book.price.toFixed(2)} JOD</p>
                    <p>Book ID: ${book.id}</p>
                `;
                bookList.appendChild(bookCard);
            });
        }

        // Handle request form submission (Customer View)
        document.getElementById('request-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const request = {
                id: Date.now(),
                bookId: parseInt(formData.get('bookId')),
                customerName: formData.get('name'),
                contact: formData.get('contact'),
                location: formData.get('location'),
                status: 'pending'
            };

            let requests = JSON.parse(localStorage.getItem('requests') || '[]');
            requests.push(request);
            localStorage.setItem('requests', JSON.stringify(requests));

            alert('Request submitted successfully!');
            this.reset();
        });

        // Handle add book form submission (Seller View)
        document.getElementById('add-book-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const newBook = {
                id: Date.now(), // Temporary ID, reassigned in loadBooks
                title: formData.get('title'),
                description: formData.get('description'),
                price: parseFloat(formData.get('price')),
                image: formData.get('image') || 'https://via.placeholder.com/150'
            };

            let books = JSON.parse(localStorage.getItem('books') || '[]');
            books.push(newBook);
            localStorage.setItem('books', JSON.stringify(books));

            alert('Book added successfully!');
            this.reset();

            // Refresh Customer View to show new book
            loadBooks();
        });

        // Load and display requests in Seller View
        function loadRequests() {
            const requestTableBody = document.getElementById('request-table-body');
            requestTableBody.innerHTML = '';
            const selectedCity = document.getElementById('city-filter').value;
            const requests = JSON.parse(localStorage.getItem('requests') || '[]');
            requests.forEach(request => {
                const row = document.createElement('tr');
                if (selectedCity && request.location === selectedCity) {
                    row.className = 'highlight';
                }
                row.innerHTML = `
                    <td>${request.bookId}</td>
                    <td>${request.customerName}</td>
                    <td>${request.contact}</td>
                    <td>${request.location}</td>
                    <td>${request.status}</td>
                    <td>
                        <button class="accept-btn" onclick="updateRequestStatus(${request.id}, 'accepted')">Accept</button>
                        <button class="ignore-btn" onclick="updateRequestStatus(${request.id}, 'ignored')">Ignore</button>
                    </td>
                `;
                requestTableBody.appendChild(row);
            });
        }

        // Update request status
        function updateRequestStatus(requestId, status) {
            let requests = JSON.parse(localStorage.getItem('requests') || '[]');
            requests = requests.map(request => {
                if (request.id === requestId) {
                    return { ...request, status };
                }
                return request;
            });
            localStorage.setItem('requests', JSON.stringify(requests));
            loadRequests();
            alert(`Request ${status}!`);
        }

        // Initialize Customer View
        document.addEventListener('DOMContentLoaded', () => {
            loadBooks();
        });
    </script>
</body>
</html>